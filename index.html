<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ±‰å­—å£°è°ƒç»ƒä¹ æ¸¸æˆï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
  <style>
    :root{
      --c1:#FF6F61; /* é²œè‰³çº¢ */
      --c2:#FFB74D; /* æ©™è‰² */
      --c3:#4DB6AC; /* ç»¿è‰² */
      --c4:#64B5F6; /* è“è‰² */
      --c5:#BA68C8; /* ç´«è‰² */
      --bg1:#FFF3E0;
      --bg2:#E1F5FE;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Comic Sans MS","Helvetica Neue",Arial,"PingFang SC",sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),#F3E5F5);
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;padding:20px;
    }
    .wrap{
      width:100%;max-width:980px;background:#fff;border-radius:18px;
      padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.12);
    }
    header{display:flex;align-items:center;gap:12px}
    .logo{width:84px;height:84px;border-radius:18px;
      background:conic-gradient(from 45deg,var(--c1),var(--c2),var(--c3),var(--c4),var(--c5),var(--c1));
      display:flex;align-items:center;justify-content:center;color:#fff;font-size:40px;font-weight:900;box-shadow:0 8px 26px rgba(0,0,0,0.18)}
    h1{margin:0;font-size:24px;color:var(--c1)}
    main{margin-top:14px}

    /* é¦–é¡µ */
    #home{display:block}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 8px 22px rgba(0,0,0,0.06);margin-bottom:14px}
    .grade-selects{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .grade-btn{flex:1;min-width:120px;padding:14px;border-radius:12px;font-weight:900;
      background:linear-gradient(135deg,var(--c2),var(--c1));color:#fff;text-align:center;cursor:pointer;transition:.15s}
    .grade-btn.selected{outline:5px solid rgba(100,181,246,0.3);transform:translateY(-4px)}
    .num-select{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .num-btn{padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--c3),var(--c4));color:#fff}
    .num-btn.selected{outline:4px solid rgba(186,104,200,0.25);transform:scale(1.03)}
    .custom-box{display:flex;align-items:center;gap:8px;margin-top:10px}
    .custom-input{width:90px;padding:8px;border:3px solid var(--c4);border-radius:10px;text-align:center;font-weight:700}
    .start-btn{background:linear-gradient(90deg,var(--c1),var(--c2));border:none;color:#fff;
      padding:14px 20px;border-radius:14px;font-weight:900;font-size:16px;cursor:pointer;
      box-shadow:0 8px 28px rgba(0,0,0,0.18);margin-top:14px}

    /* æ¸¸æˆç•Œé¢ */
    #game{display:none}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .char-box{text-align:center;margin:14px 0}
    .char-box .han{font-size:110px;font-weight:900;color:var(--c1)}
    .meta{font-size:16px;margin-top:6px;color:#333}
    .play-btn{margin-top:8px;padding:8px 14px;border:none;border-radius:12px;
      background:linear-gradient(90deg,var(--c3),var(--c4));color:#fff;font-weight:800;cursor:pointer}
    .choices{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    .choice{padding:16px;border-radius:14px;font-weight:900;font-size:22px;cursor:pointer;
      background:linear-gradient(135deg,#FFFDE7,#FFF9C4);border:3px solid rgba(0,0,0,0.03);transition:.12s}
    .choice:hover{transform:translateY(-4px)}
    .choice.correct{background:linear-gradient(135deg,#DCEDC8,#A5D6A7);border-color:#43A047;color:#1B5E20}
    .choice.wrong{background:linear-gradient(135deg,#FFCDD2,#EF9A9A);border-color:#E53935;color:#B71C1C}
    .progress{height:14px;background:#eee;border-radius:8px;overflow:hidden;margin-top:12px}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--c2),var(--c1))}
    .next-btn{background:linear-gradient(90deg,var(--c4),var(--c5));border:none;color:#fff;padding:10px 16px;
      border-radius:12px;font-weight:900;margin-top:12px;cursor:pointer}
    .home-btn{background:#fff;border:2px dashed var(--c4);padding:8px 12px;border-radius:12px;cursor:pointer;margin-top:12px}

    /* å½•éŸ³è¡Œ */
    .rec-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
    .rec-btn{padding:8px 12px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
    .rec-indicator{font-size:13px;color:#666;margin-left:6px}

    /* ç»“æŸé¡µ */
    #end{display:none;text-align:center}
    .end-card{padding:20px;border-radius:16px;background:linear-gradient(135deg,#FFF3E0,#FFE0B2)}
    .score-big{font-size:36px;font-weight:900;color:var(--c1);margin:10px 0}
    .tone-grid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
    .tone-item{padding:10px 14px;border-radius:12px;font-weight:800;background:linear-gradient(135deg,var(--c3),var(--c4));color:#fff}
    .encourage{margin-top:12px;font-size:18px;font-weight:900;color:var(--c5)}

    footer{margin-top:16px;text-align:center;color:#999;font-weight:700}

    @media (max-width:760px){
      .char-box .han{font-size:76px}
      .choices{grid-template-columns:1fr}
    }
    img.stroke-gif{max-width:180px;max-height:180px;display:block;margin:8px auto}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="æ±‰å­—å£°è°ƒç»ƒä¹ ">
    <header>
      <div class="logo">å£°</div>
      <h1>æ±‰å­—å£°è°ƒç»ƒä¹ </h1>
    </header>

    <main>
      <!-- HOME -->
      <section id="home">
        <div class="card">
          <div style="font-weight:900">è¯·é€‰æ‹©å¹´çº§</div>
          <div class="grade-selects" id="grade-selects">
            <div class="grade-btn" data-grade="1">ä¸€å¹´çº§<br><span style="font-size:13px;opacity:.9">47 å­—</span></div>
            <div class="grade-btn" data-grade="2">äºŒå¹´çº§<br><span style="font-size:13px;opacity:.9">62 å­—</span></div>
            <div class="grade-btn" data-grade="3">ä¸‰å¹´çº§<br><span style="font-size:13px;opacity:.9">79 å­—</span></div>
            <div class="grade-btn" data-grade="4">å››å¹´çº§<br><span style="font-size:13px;opacity:.9">85 å­—</span></div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900">é¢˜ç›®æ•°é‡</div>
          <div class="num-select" id="num-select">
            <div class="num-btn" data-num="10">10</div>
            <div class="num-btn" data-num="20">20</div>
            <div class="num-btn selected" data-num="all">å…¨éƒ¨</div>
          </div>
          <div class="custom-box">
            <label for="custom-num" style="font-weight:800">è‡ªå®šä¹‰ï¼š</label>
            <input id="custom-num" class="custom-input" type="number" min="1" placeholder="æ•°é‡">
            <div style="font-size:13px;color:#666">ï¼ˆè¶…è¿‡æœ€å¤§å€¼ä¼šè‡ªåŠ¨å–æœ€å¤§ï¼‰</div>
          </div>
        </div>

        <button id="start-game" class="start-btn">å¼€å§‹ç»ƒä¹  âœ¨</button>
      </section>

      <!-- GAME -->
      <section id="game" aria-live="polite">
        <div class="topbar">
          <div id="game-grade" style="font-weight:900">å¹´çº§ -</div>
          <div id="q-count" style="font-weight:900">0 / 0</div>
        </div>

        <div class="char-box">
          <div id="gif-container">
            <img id="stroke-gif" class="stroke-gif" alt="" title="">
          </div>
          <div class="meta" id="meta-line">ï¼ˆé‡Šä¹‰ï¼‰</div>
          <div style="margin-top:6px">
            <button id="play-sound" class="play-btn">ğŸ”Š æ’­æ”¾é¢˜å¹²éŸ³</button>
          </div>

          <!-- å½•éŸ³æ§ä»¶è¡Œ -->
          <div class="rec-row">
            <button id="rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c1),var(--c2));color:#fff">å½•éŸ³ â—</button>
            <button id="stop-rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c3),var(--c4));color:#fff;display:none">åœæ­¢</button>
            <button id="play-rec-btn" class="rec-btn" style="background:linear-gradient(90deg,var(--c4),var(--c5));color:#fff;display:none">â–¶ æ’­æ”¾å½•éŸ³</button>
            <span id="rec-status" class="rec-indicator">ï¼ˆæœªå½•éŸ³ï¼‰</span>
            <!-- å½•éŸ³æ’­æ”¾å…ƒç´ ä¼šåœ¨å³ä¾§æ˜¾ç¤º -->
            <audio id="user-rec-audio" controls style="display:none;margin-left:8px"></audio>
          </div>
        </div>

        <div class="choices" id="choices"></div>

        <div class="progress"><div id="progress-bar"></div></div>
        <div id="score-text" style="margin-top:10px;font-weight:900">å¾—åˆ†ï¼š0</div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="next-btn" class="next-btn" style="display:none">ä¸‹ä¸€é¢˜ â¡</button>
          <button id="quit-btn" class="home-btn">ç»“æŸå¹¶è¿”å›</button>
        </div>
      </section>

      <!-- END -->
      <section id="end">
        <div class="end-card">
          <div style="font-weight:900">æœ¬è½®å®Œæˆ ğŸ‰</div>
          <div class="score-big" id="final-score">0 / 0</div>
          <div style="font-weight:800">å„å£°è°ƒæ­£ç¡®ç‡ï¼š</div>
          <div class="tone-grid" id="tone-grid"></div>
          <div class="encourage" id="encourage"></div>
          <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
            <button id="retry-btn" class="start-btn">å†æ¥ä¸€æ¬¡ ğŸ”</button>
            <button id="back-home-btn" class="home-btn">è¿”å›é¦–é¡µ ğŸ </button>
          </div>
        </div>
      </section>
    </main>

    <footer>å¿«ä¹å­¦æ±‰å­— ğŸˆ</footer>
  </div>

  <audio id="audio" preload="auto" style="display:none"></audio>

  <script>
    /*************************************************************************
     * æ•°æ®ä¸æ˜ å°„
     *************************************************************************/

    const gradeChars = {
      1: ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹","å","ä¸Š","ä¸‹","å¤§","å°","ä¸","å","åœ¨","é‡Œ","å±±","æ°´","ç«","äºº","é©¬","ç‰›","ç¾Š","é¸Ÿ","è™«","ç”·","å¥³","é›¨","åœŸ","æœˆ","å¤©","æ—¥","ç”Ÿ","ä»Š","æ˜¯","æ˜","æ˜¨","èµ°","å»","æ¥","ç”°","æ˜Ÿ","æœŸ","å‡ ","å¹´"],
      2: ["æˆ‘","ä½ ","å¥½","ä»¬","å¯","ä»¥","æœ‹","å‹","çš„","å“ª","è¿™","å—","è¦","é¢","ä»–","å¥¹","ç©","è·Ÿ","å–œ","æ¬¢","åƒ","å¾ˆ","ä»€","ä¹ˆ","è¯¾","çœ‹","ä¹¦","è€","å¸ˆ","ä¸º","æœ‰","æ²¡","å¤–","å› ","é›ª","è¯´","ç»™","å¦ˆ","çˆ¸","å","å‰","å¯¹","å­¦","æ ¡","å®¶","åˆ°","å›","æ”¾","æ€","è°","ä¼š","ä¹Ÿ","å¸®","èƒ½","æ¯","å²","æ—¶","å€™","å¿«","ä¹","é«˜","å…´"],
      3: ["å§","å¦¹","é•¿","çˆ±","æƒ³","æ ·","éƒ½","å“¥","å¼Ÿ","å¤ª","ä¸¤","å’Œ","å‡º","è¿›","å«","å†","è§","å›½","ä¸­","èµ·","ç¾","å†™","ç”¨","å¤š","è°¢","ç‚¹","ä¸œ","è¥¿","å°‘","è¾¹","å°±","å¦‚","è¿˜","æœ","æ‰€","é‚£","åœ°","æ–¹","å¤","çƒ­","é˜³","æ¯”","å‡","åš","è¿‡","å¾—","é€","ä½","é¥­","è‡ª","å·±","å¥¶","çˆ·","æˆ¿","åŠ ","å†·","ç§‹","ç­‰","äº","å–","çŸ¥","é“","æ—©","åˆ","æ™š","ç€","ç´¯","ç¡","è§‰","åºŠ","ç”»","çº¢","ç™½","äº‘","æŠŠ","æ‹¿","åˆ","è‰²","å¿ƒ"],
      4: ["ä¹°","é’±","ç™¾","æ•°","å—","æ‰¾","çœŸ","ç°","è¯·","é—®","ä»","è¿œ","è¿‘","æ—","å…¬","å›­","åª","è¡Œ","è½¦","é£","æœº","è·‘","æ…¢","æ›´","æœ€","çƒ","æ‰“","æ¬¡","åˆ†","å½“","é","å¸¸","å†¬","ç¬¬","æ°‘","æ”¶","è¡£","æœ","æ²³","ç‹—","åŠ©","ç½‘","å®ƒ","æ˜¥","èŠ‚","åŒ…","å­©","æ–°","é—¨","å£","ç©¿","ä¸¾","å¬","è¯","å¿˜","è®°","ç­”","æ•™","çº§","æ‰‹","åº—","å¼€","å…³","é€‰","åˆ«","äº›","å…ˆ","ç„¶","ç¬‘","å“­","æ€•","é»‘","ä½†","å›¾","å˜","æˆ","åº”","è¯¥","æ´—","å¤´","æ‰","åŠ¨","è®©","å®Œ","åˆš"]
    };

    // pinyinMap æ”¯æŒå¤šéŸ³å­—ï¼ˆtone å¯ä»¥ä¸ºæ•°å­—æˆ–æ•°ç»„ï¼‰
    const pinyinMap = {
      /* Grade1 */
      "ä¸€":{pinyinBase:"yi",tone:1},"äºŒ":{pinyinBase:"er",tone:4},"ä¸‰":{pinyinBase:"san",tone:1},"å››":{pinyinBase:"si",tone:4},"äº”":{pinyinBase:"wu",tone:3},
      "å…­":{pinyinBase:"liu",tone:4},"ä¸ƒ":{pinyinBase:"qi",tone:1},"å…«":{pinyinBase:"ba",tone:1},"ä¹":{pinyinBase:"jiu",tone:3},"å":{pinyinBase:"shi",tone:2},
      "ä¸Š":{pinyinBase:"shang",tone:4},"ä¸‹":{pinyinBase:"xia",tone:4},"å¤§":{pinyinBase:"da",tone:4},"å°":{pinyinBase:"xiao",tone:3},"ä¸":{pinyinBase:"bu",tone:4},
      "å":{pinyinBase:"zuo",tone:4},"åœ¨":{pinyinBase:"zai",tone:4},"é‡Œ":{pinyinBase:"li",tone:3},"å±±":{pinyinBase:"shan",tone:1},"æ°´":{pinyinBase:"shui",tone:3},
      "ç«":{pinyinBase:"huo",tone:3},"äºº":{pinyinBase:"ren",tone:2},"é©¬":{pinyinBase:"ma",tone:3},"ç‰›":{pinyinBase:"niu",tone:2},"ç¾Š":{pinyinBase:"yang",tone:2},
      "é¸Ÿ":{pinyinBase:"niao",tone:3},"è™«":{pinyinBase:"chong",tone:2},"ç”·":{pinyinBase:"nan",tone:2},"å¥³":{pinyinBase:"nv",tone:3},"é›¨":{pinyinBase:"yu",tone:3},
      "åœŸ":{pinyinBase:"tu",tone:3},"æœˆ":{pinyinBase:"yue",tone:4},"å¤©":{pinyinBase:"tian",tone:1},"æ—¥":{pinyinBase:"ri",tone:4},"ç”Ÿ":{pinyinBase:"sheng",tone:1},
      "ä»Š":{pinyinBase:"jin",tone:1},"æ˜¯":{pinyinBase:"shi",tone:4},"æ˜":{pinyinBase:"ming",tone:2},"æ˜¨":{pinyinBase:"zuo",tone:2},"èµ°":{pinyinBase:"zou",tone:3},
      "å»":{pinyinBase:"qu",tone:4},"æ¥":{pinyinBase:"lai",tone:2},"ç”°":{pinyinBase:"tian",tone:2},"æ˜Ÿ":{pinyinBase:"xing",tone:1},"æœŸ":{pinyinBase:"qi",tone:1},
      "å‡ ":{pinyinBase:"ji",tone:3},"å¹´":{pinyinBase:"nian",tone:2},

      /* Grade 2 */
      "æˆ‘":{pinyinBase:"wo",tone:3},"ä½ ":{pinyinBase:"ni",tone:3},"å¥½":{pinyinBase:"hao",tone:[3,4]},"ä»¬":{pinyinBase:"men",tone:0},"å¯":{pinyinBase:"ke",tone:3},
      "ä»¥":{pinyinBase:"yi",tone:3},"æœ‹":{pinyinBase:"peng",tone:2},"å‹":{pinyinBase:"you",tone:3},"çš„":{pinyinBase:"de",tone:0},"å“ª":{pinyinBase:"na",tone:3},
      "è¿™":{pinyinBase:"zhe",tone:4},"å—":{pinyinBase:"ma",tone:0},"è¦":{pinyinBase:"yao",tone:4},"é¢":{pinyinBase:"mian",tone:4},"ä»–":{pinyinBase:"ta",tone:1},
      "å¥¹":{pinyinBase:"ta",tone:1},"ç©":{pinyinBase:"wan",tone:2},"è·Ÿ":{pinyinBase:"gen",tone:1},"å–œ":{pinyinBase:"xi",tone:3},"æ¬¢":{pinyinBase:"huan",tone:1},
      "åƒ":{pinyinBase:"chi",tone:1},"å¾ˆ":{pinyinBase:"hen",tone:3},"ä»€":{pinyinBase:"shen",tone:2},"ä¹ˆ":{pinyinBase:"me",tone:0},"è¯¾":{pinyinBase:"ke",tone:4},
      "çœ‹":{pinyinBase:"kan",tone:4},"ä¹¦":{pinyinBase:"shu",tone:1},"è€":{pinyinBase:"lao",tone:3},"å¸ˆ":{pinyinBase:"shi",tone:1},"ä¸º":{pinyinBase:"wei",tone:4},
      "æœ‰":{pinyinBase:"you",tone:3},"æ²¡":{pinyinBase:"mei",tone:2},"å¤–":{pinyinBase:"wai",tone:4},"å› ":{pinyinBase:"yin",tone:1},"é›ª":{pinyinBase:"xue",tone:3},
      "è¯´":{pinyinBase:"shuo",tone:1},"ç»™":{pinyinBase:"gei",tone:3},"å¦ˆ":{pinyinBase:"ma",tone:1},"çˆ¸":{pinyinBase:"ba",tone:4},"å":{pinyinBase:"hou",tone:4},
      "å‰":{pinyinBase:"qian",tone:2},"å¯¹":{pinyinBase:"dui",tone:4},"å­¦":{pinyinBase:"xue",tone:2},"æ ¡":{pinyinBase:"xiao",tone:4},"å®¶":{pinyinBase:"jia",tone:1},
      "åˆ°":{pinyinBase:"dao",tone:4},"å›":{pinyinBase:"hui",tone:2},"æ”¾":{pinyinBase:"fang",tone:4},"æ€":{pinyinBase:"zen",tone:3},"è°":{pinyinBase:"shui",tone:2},
      "ä¼š":{pinyinBase:"hui",tone:4},"ä¹Ÿ":{pinyinBase:"ye",tone:3},"å¸®":{pinyinBase:"bang",tone:1},"èƒ½":{pinyinBase:"neng",tone:2},"æ¯":{pinyinBase:"mei",tone:3},
      "å²":{pinyinBase:"sui",tone:4},"æ—¶":{pinyinBase:"shi",tone:2},"å€™":{pinyinBase:"hou",tone:4},"å¿«":{pinyinBase:"kuai",tone:4},"ä¹":{pinyinBase:"le",tone:4},
      "é«˜":{pinyinBase:"gao",tone:1},"å…´":{pinyinBase:"xing",tone:4},

      /* Grade 3 */
      "å§":{pinyinBase:"jie",tone:3},"å¦¹":{pinyinBase:"mei",tone:4},"é•¿":{pinyinBase:"zhang",tone:3},"çˆ±":{pinyinBase:"ai",tone:4},"æƒ³":{pinyinBase:"xiang",tone:3},
      "æ ·":{pinyinBase:"yang",tone:4},"éƒ½":{pinyinBase:"dou",tone:1},"å“¥":{pinyinBase:"ge",tone:1},"å¼Ÿ":{pinyinBase:"di",tone:4},"å¤ª":{pinyinBase:"tai",tone:4},
      "ä¸¤":{pinyinBase:"liang",tone:3},"å’Œ":{pinyinBase:"he",tone:2},"å‡º":{pinyinBase:"chu",tone:1},"è¿›":{pinyinBase:"jin",tone:4},"å«":{pinyinBase:"jiao",tone:4},
      "å†":{pinyinBase:"zai",tone:4},"è§":{pinyinBase:"jian",tone:4},"å›½":{pinyinBase:"guo",tone:2},"ä¸­":{pinyinBase:"zhong",tone:1},"èµ·":{pinyinBase:"qi",tone:3},
      "ç¾":{pinyinBase:"mei",tone:3},"å†™":{pinyinBase:"xie",tone:3},"ç”¨":{pinyinBase:"yong",tone:4},"å¤š":{pinyinBase:"duo",tone:1},"è°¢":{pinyinBase:"xie",tone:4},
      "ç‚¹":{pinyinBase:"dian",tone:3},"ä¸œ":{pinyinBase:"dong",tone:1},"è¥¿":{pinyinBase:"xi",tone:1},"å°‘":{pinyinBase:"shao",tone:3},"è¾¹":{pinyinBase:"bian",tone:1},
      "å°±":{pinyinBase:"jiu",tone:4},"å¦‚":{pinyinBase:"ru",tone:2},"è¿˜":{pinyinBase:"hai",tone:2},"æœ":{pinyinBase:"guo",tone:3},"æ‰€":{pinyinBase:"suo",tone:3},
      "é‚£":{pinyinBase:"na",tone:4},"åœ°":{pinyinBase:"di",tone:4},"æ–¹":{pinyinBase:"fang",tone:1},"å¤":{pinyinBase:"xia",tone:4},"çƒ­":{pinyinBase:"re",tone:4},
      "é˜³":{pinyinBase:"yang",tone:2},"æ¯”":{pinyinBase:"bi",tone:3},"å‡":{pinyinBase:"jia",tone:3},"åš":{pinyinBase:"zuo",tone:4},"è¿‡":{pinyinBase:"guo",tone:4},
      "å¾—":{pinyinBase:"de",tone:0},"é€":{pinyinBase:"song",tone:4},"ä½":{pinyinBase:"zhu",tone:4},"é¥­":{pinyinBase:"fan",tone:4},"è‡ª":{pinyinBase:"zi",tone:4},
      "å·±":{pinyinBase:"ji",tone:3},"å¥¶":{pinyinBase:"nai",tone:3},"çˆ·":{pinyinBase:"ye",tone:2},"æˆ¿":{pinyinBase:"fang",tone:2},"åŠ ":{pinyinBase:"jia",tone:1},
      "å†·":{pinyinBase:"leng",tone:3},"ç§‹":{pinyinBase:"qiu",tone:1},"ç­‰":{pinyinBase:"deng",tone:3},"äº":{pinyinBase:"yu",tone:2},"å–":{pinyinBase:"he",tone:1},
      "çŸ¥":{pinyinBase:"zhi",tone:1},"é“":{pinyinBase:"dao",tone:4},"æ—©":{pinyinBase:"zao",tone:3},"åˆ":{pinyinBase:"wu",tone:3},"æ™š":{pinyinBase:"wan",tone:3},
      "ç€":{pinyinBase:"zhe",tone:0},"ç´¯":{pinyinBase:"lei",tone:4},"ç¡":{pinyinBase:"shui",tone:4},"è§‰":{pinyinBase:"jiao",tone:4},"åºŠ":{pinyinBase:"chuang",tone:2},
      "ç”»":{pinyinBase:"hua",tone:4},"çº¢":{pinyinBase:"hong",tone:2},"ç™½":{pinyinBase:"bai",tone:2},"äº‘":{pinyinBase:"yun",tone:2},"æŠŠ":{pinyinBase:"ba",tone:3},
      "æ‹¿":{pinyinBase:"na",tone:2},"åˆ":{pinyinBase:"you",tone:4},"è‰²":{pinyinBase:"se",tone:4},"å¿ƒ":{pinyinBase:"xin",tone:1},

      /* Grade 4 */
      "ä¹°":{pinyinBase:"mai",tone:3},"é’±":{pinyinBase:"qian",tone:2},"ç™¾":{pinyinBase:"bai",tone:3},"æ•°":{pinyinBase:"shu",tone:4},"å—":{pinyinBase:"kuai",tone:4},
      "æ‰¾":{pinyinBase:"zhao",tone:3},"çœŸ":{pinyinBase:"zhen",tone:1},"ç°":{pinyinBase:"xian",tone:4},"è¯·":{pinyinBase:"qing",tone:3},"é—®":{pinyinBase:"wen",tone:4},
      "ä»":{pinyinBase:"cong",tone:2},"è¿œ":{pinyinBase:"yuan",tone:3},"è¿‘":{pinyinBase:"jin",tone:4},"æ—":{pinyinBase:"pang",tone:2},"å…¬":{pinyinBase:"gong",tone:1},
      "å›­":{pinyinBase:"yuan",tone:2},"åª":{pinyinBase:"zhi",tone:[1,3]},"è¡Œ":{pinyinBase:"xing",tone:2},"è½¦":{pinyinBase:"che",tone:1},"é£":{pinyinBase:"fei",tone:1},
      "æœº":{pinyinBase:"ji",tone:1},"è·‘":{pinyinBase:"pao",tone:3},"æ…¢":{pinyinBase:"man",tone:4},"æ›´":{pinyinBase:"geng",tone:4},"æœ€":{pinyinBase:"zui",tone:4},
      "çƒ":{pinyinBase:"qiu",tone:2},"æ‰“":{pinyinBase:"da",tone:3},"æ¬¡":{pinyinBase:"ci",tone:4},"åˆ†":{pinyinBase:"fen",tone:1},"å½“":{pinyinBase:"dang",tone:1},
      "é":{pinyinBase:"fei",tone:1},"å¸¸":{pinyinBase:"chang",tone:2},"å†¬":{pinyinBase:"dong",tone:1},"ç¬¬":{pinyinBase:"di",tone:4},"æ°‘":{pinyinBase:"min",tone:2},
      "æ”¶":{pinyinBase:"shou",tone:1},"è¡£":{pinyinBase:"yi",tone:1},"æœ":{pinyinBase:"fu",tone:2},"æ²³":{pinyinBase:"he",tone:2},"ç‹—":{pinyinBase:"gou",tone:3},
      "åŠ©":{pinyinBase:"zhu",tone:4},"ç½‘":{pinyinBase:"wang",tone:3},"å®ƒ":{pinyinBase:"ta",tone:1},"æ˜¥":{pinyinBase:"chun",tone:1},"èŠ‚":{pinyinBase:"jie",tone:2},
      "åŒ…":{pinyinBase:"bao",tone:1},"å­©":{pinyinBase:"hai",tone:2},"æ–°":{pinyinBase:"xin",tone:1},"é—¨":{pinyinBase:"men",tone:2},"å£":{pinyinBase:"kou",tone:3},
      "ç©¿":{pinyinBase:"chuan",tone:1},"ä¸¾":{pinyinBase:"ju",tone:3},"å¬":{pinyinBase:"ting",tone:1},"è¯":{pinyinBase:"hua",tone:4},"å¿˜":{pinyinBase:"wang",tone:4},
      "è®°":{pinyinBase:"ji",tone:4},"ç­”":{pinyinBase:"da",tone:2},"æ•™":{pinyinBase:"jiao",tone:4},"çº§":{pinyinBase:"ji",tone:2},"æ‰‹":{pinyinBase:"shou",tone:3},
      "åº—":{pinyinBase:"dian",tone:4},"å¼€":{pinyinBase:"kai",tone:1},"å…³":{pinyinBase:"guan",tone:1},"é€‰":{pinyinBase:"xuan",tone:3},"åˆ«":{pinyinBase:"bie",tone:2},
      "äº›":{pinyinBase:"xie",tone:1},"å…ˆ":{pinyinBase:"xian",tone:1},"ç„¶":{pinyinBase:"ran",tone:2},"ç¬‘":{pinyinBase:"xiao",tone:4},"å“­":{pinyinBase:"ku",tone:1},
      "æ€•":{pinyinBase:"pa",tone:4},"é»‘":{pinyinBase:"hei",tone:1},"ä½†":{pinyinBase:"dan",tone:4},"å›¾":{pinyinBase:"tu",tone:2},"å˜":{pinyinBase:"bian",tone:4},
      "æˆ":{pinyinBase:"cheng",tone:2},"åº”":{pinyinBase:"ying",tone:1},"è¯¥":{pinyinBase:"gai",tone:1},"æ´—":{pinyinBase:"xi",tone:3},"å¤´":{pinyinBase:"tou",tone:2},
      "æ‰":{pinyinBase:"cai",tone:2},"åŠ¨":{pinyinBase:"dong",tone:4},"è®©":{pinyinBase:"rang",tone:4},"å®Œ":{pinyinBase:"wan",tone:2},"åˆš":{pinyinBase:"gang",tone:1}
    };

    // lexicon: æ±‰å­— -> "pos. English"ï¼ˆä¿ç•™è¯æ€§ä¿¡æ¯ï¼‰
    const lexicon = {
      /* Grade1 */
      "ä¸€":"num. one","äºŒ":"num. two","ä¸‰":"num. three","å››":"num. four","äº”":"num. five",
      "å…­":"num. six","ä¸ƒ":"num. seven","å…«":"num. eight","ä¹":"num. nine","å":"num. ten",
      "ä¸Š":"prep./adv. up; above","ä¸‹":"prep./adv. down; below","å¤§":"adj. big","å°":"adj. small","ä¸":"adv. not",
      "å":"v. sit","åœ¨":"prep. at; in","é‡Œ":"prep. in; inside","å±±":"n. mountain","æ°´":"n. water",
      "ç«":"n. fire","äºº":"n. person","é©¬":"n. horse","ç‰›":"n. cow","ç¾Š":"n. sheep",
      "é¸Ÿ":"n. bird","è™«":"n. insect","ç”·":"n. male","å¥³":"n. female","é›¨":"n. rain",
      "åœŸ":"n. soil","æœˆ":"n. month; moon","å¤©":"n. sky; day","æ—¥":"n. day; sun","ç”Ÿ":"v./n. born; life",
      "ä»Š":"adv. now","æ˜¯":"v. is; are","æ˜":"adj. bright; next (as in æ˜å¤©)","æ˜¨":"n. yesterday","èµ°":"v. walk",
      "å»":"v. go","æ¥":"v. come","ç”°":"n. field","æ˜Ÿ":"n. star","æœŸ":"n. period; week",
      "å‡ ":"pron. how many","å¹´":"n. year",

      /* Grade2 */
      "æˆ‘":"pron. I; me","ä½ ":"pron. you","å¥½":"adj. good","ä»¬":"suf. plural marker","å¯":"aux. can; may",
      "ä»¥":"v./prep. to use; can","æœ‹":"n. friend (part)","å‹":"n. friend","çš„":"part. possessive","å“ª":"pron. which",
      "è¿™":"pron. this","å—":"particle (question)","è¦":"v. want; need","é¢":"n. face; noodle","ä»–":"pron. he",
      "å¥¹":"pron. she","ç©":"v. play","è·Ÿ":"prep. with","å–œ":"v./n. like (part)","æ¬¢":"v./n. like (part)",
      "åƒ":"v. eat","å¾ˆ":"adv. very","ä»€":"pron. what (part)","ä¹ˆ":"part. (what)","è¯¾":"n. class",
      "çœ‹":"v. look; read","ä¹¦":"n. book","è€":"adj. old","å¸ˆ":"n. teacher (part)","ä¸º":"prep. for",
      "æœ‰":"v. have","æ²¡":"adv. not have","å¤–":"adj. outside","å› ":"prep. because","é›ª":"n. snow",
      "è¯´":"v. say","ç»™":"v. give","å¦ˆ":"n. mom","çˆ¸":"n. dad","å":"n. after; behind",
      "å‰":"n. front; before","å¯¹":"adj./prep. correct; towards","å­¦":"v. learn","æ ¡":"n. school","å®¶":"n. home; family",
      "åˆ°":"v. arrive","å›":"v. return","æ”¾":"v. put","æ€":"adv. how (part)","è°":"pron. who",
      "ä¼š":"aux. can; meet","ä¹Ÿ":"adv. also","å¸®":"v. help","èƒ½":"aux. can","æ¯":"adv. every",
      "å²":"n. years (age)","æ—¶":"n. time","å€™":"n. time; moment","å¿«":"adj. fast","ä¹":"adj./n. happy; music",
      "é«˜":"adj. tall; high","å…´":"adj. happy",

      /* Grade3 */
      "å§":"n. older sister","å¦¹":"n. younger sister","é•¿":"adj. long; v. grow","çˆ±":"v. love","æƒ³":"v. think; want",
      "æ ·":"n. type; manner","éƒ½":"adv. all","å“¥":"n. older brother","å¼Ÿ":"n. younger brother","å¤ª":"adv. too",
      "ä¸¤":"num. two (pair)","å’Œ":"conj. and","å‡º":"v. go out","è¿›":"v. enter","å«":"v. call",
      "å†":"adv. again","è§":"v. see; meet","å›½":"n. country","ä¸­":"prep. in; middle","èµ·":"v. get up; start",
      "ç¾":"adj. beautiful","å†™":"v. write","ç”¨":"v. use","å¤š":"adj. many","è°¢":"v. thank",
      "ç‚¹":"n. dot; o'clock; a little","ä¸œ":"n. east","è¥¿":"n. west","å°‘":"adj. few","è¾¹":"n. side",
      "å°±":"adv. then; right away","å¦‚":"conj. if; like","è¿˜":"adv. still; return","æœ":"n. fruit","æ‰€":"n. place",
      "é‚£":"pron. that","åœ°":"part. (adverbial)","æ–¹":"n. direction; place","å¤":"n. summer","çƒ­":"adj. hot",
      "é˜³":"n. sun","æ¯”":"v. compare","å‡":"adj. fake; holiday","åš":"v. do","è¿‡":"v./aux. pass; have done",
      "å¾—":"part. (complement)","é€":"v. give; deliver","ä½":"v. live; stay","é¥­":"n. meal; rice","è‡ª":"pron. self",
      "å·±":"pron. self","å¥¶":"n. milk; grandma","çˆ·":"n. grandpa","æˆ¿":"n. house; room","åŠ ":"v. add",
      "å†·":"adj. cold","ç§‹":"n. autumn","ç­‰":"v. wait","äº":"prep. at; in","å–":"v. drink",
      "çŸ¥":"v. know","é“":"n./v. way; know","æ—©":"adj. early","åˆ":"n. noon","æ™š":"adj. late",
      "ç€":"part. aspect/particle","ç´¯":"adj. tired","ç¡":"v. sleep","è§‰":"n. sleep","åºŠ":"n. bed",
      "ç”»":"v. draw","çº¢":"adj. red","ç™½":"adj. white","äº‘":"n. cloud","æŠŠ":"prep/verb marker",
      "æ‹¿":"v. take","åˆ":"adv. again","è‰²":"n. color","å¿ƒ":"n. heart; mind",

      /* Grade4 */
      "ä¹°":"v. buy","é’±":"n. money","ç™¾":"num. hundred","æ•°":"v. count; number","å—":"m. piece; measure word",
      "æ‰¾":"v. find","çœŸ":"adj. real; true","ç°":"v. appear; present","è¯·":"v./polite please","é—®":"v. ask",
      "ä»":"prep. from","è¿œ":"adj. far","è¿‘":"adj. near","æ—":"n. beside","å…¬":"adj. public",
      "å›­":"n. park; garden","åª":"adv./m. only; measure","è¡Œ":"v./n. walk; line","è½¦":"n. vehicle","é£":"v. fly",
      "æœº":"n. machine","è·‘":"v. run","æ…¢":"adj. slow","æ›´":"adv. more","æœ€":"adv. most",
      "çƒ":"n. ball","æ‰“":"v. hit","æ¬¡":"n. time; occurrence","åˆ†":"v./n. divide; minute","å½“":"v. act as; ought to",
      "é":"adv. not; very","å¸¸":"adv. very","å†¬":"n. winter","ç¬¬":"pref. ordinal","æ°‘":"n. people",
      "æ”¶":"v. receive","è¡£":"n. clothes","æœ":"n. clothes","æ²³":"n. river","ç‹—":"n. dog",
      "åŠ©":"v. help","ç½‘":"n. net; web","å®ƒ":"pron. it","æ˜¥":"n. spring","èŠ‚":"n. festival",
      "åŒ…":"n. bag","å­©":"n. child","æ–°":"adj. new","é—¨":"n. door","å£":"n. mouth",
      "ç©¿":"v. wear","ä¸¾":"v. lift; raise","å¬":"v. listen","è¯":"n. speech; words","å¿˜":"v. forget",
      "è®°":"v. remember; record","ç­”":"v. answer","æ•™":"v. teach","çº§":"n. grade; level","æ‰‹":"n. hand",
      "åº—":"n. shop","å¼€":"v. open","å…³":"v. close","é€‰":"v. choose","åˆ«":"adj. other; don't",
      "äº›":"pron. some","å…ˆ":"adv. first","ç„¶":"adv. then","ç¬‘":"v. laugh","å“­":"v. cry",
      "æ€•":"v. fear","é»‘":"adj. black","ä½†":"conj. but","å›¾":"n. picture; map","å˜":"v. change",
      "æˆ":"v. become","åº”":"v. should","è¯¥":"aux. ought to","æ´—":"v. wash","å¤´":"n. head",
      "æ‰":"adv. just; only","åŠ¨":"v. move","è®©":"v. let; allow","å®Œ":"adj. finished","åˆš":"adv. just"
    };

    /*************************************************************************
     * char->stroke gif ç¼–ç æ˜ å°„ï¼ˆæ¥è‡ªä½ ç»™å‡ºçš„æ¸…å•ï¼‰
     * ï¼ˆæ³¨æ„ï¼šè¿™é‡Œæˆ‘æŠŠä½ æä¾›çš„ç¼–ç ä¸€ä¸€åšæˆå¯¹è±¡æ˜ å°„ï¼Œç¡®ä¿æ¯ä¸ªæ±‰å­—å¯ä»¥å®šä½åˆ°å¯¹åº” gifï¼‰
     *************************************************************************/
    const charCodeMap = {
      "ä¸€":19968,"äºŒ":20108,"ä¸‰":19977,"å››":22235,"äº”":20116,"å…­":20845,"ä¸ƒ":19971,"å…«":20843,"ä¹":20061,"å":21313,
      "ä¸Š":19978,"ä¸‹":19979,"å¤§":22823,"å°":23567,"ä¸":19981,"å":22352,"åœ¨":22312,"é‡Œ":37324,"å±±":23665,"æ°´":27700,
      "ç«":28779,"äºº":20154,"é©¬":39532,"ç‰›":29275,"ç¾Š":32650,"é¸Ÿ":40479,"è™«":34411,"ç”·":30007,"å¥³":22899,"é›¨":38632,
      "åœŸ":22303,"æœˆ":26376,"å¤©":22825,"æ—¥":26085,"ç”Ÿ":29983,"ä»Š":20170,"æ˜¯":26159,"æ˜":26126,"æ˜¨":26152,"èµ°":36208,
      "å»":21435,"æ¥":26469,"ç”°":30000,"æ˜Ÿ":26143,"æœŸ":26399,"å‡ ":20960,"å¹´":24180,"æˆ‘":25105,"ä½ ":20320,"å¥½":22909,
      "ä»¬":20204,"å¯":21487,"ä»¥":20197,"æœ‹":26379,"å‹":21451,"çš„":30340,"å“ª":21738,"è¿™":36825,"å—":21527,"è¦":35201,
      "é¢":38754,"ä»–":20182,"å¥¹":22905,"ç©":29609,"è·Ÿ":36319,"å–œ":21916,"æ¬¢":27426,"åƒ":21507,"å¾ˆ":24456,"ä»€":20160,
      "ä¹ˆ":20040,"è¯¾":35838,"çœ‹":30475,"ä¹¦":20070,"è€":32769,"å¸ˆ":24072,"ä¸º":20026,"æœ‰":26377,"æ²¡":27809,"å¤–":22806,
      "å› ":22240,"é›ª":38634,"è¯´":35828,"ç»™":32473,"å¦ˆ":22920,"çˆ¸":29240,"å":21518,"å‰":21069,"å¯¹":23545,"å­¦":23398,
      "æ ¡":26657,"å®¶":23478,"åˆ°":21040,"å›":22238,"æ”¾":25918,"æ€":24590,"è°":35841,"ä¼š":20250,"ä¹Ÿ":20063,"å¸®":24110,
      "èƒ½":33021,"æ¯":27599,"å²":23681,"æ—¶":26102,"å€™":20505,"å¿«":24555,"ä¹":20048,"é«˜":39640,"å…´":20852,"å§":22992,
      "å¦¹":22969,"é•¿":38271,"çˆ±":29233,"æƒ³":24819,"æ ·":26679,"éƒ½":37117,"å“¥":21733,"å¼Ÿ":24351,"å¤ª":22826,"ä¸¤":20004,
      "å’Œ":21644,"å‡º":20986,"è¿›":36827,"å«":21483,"å†":20877,"è§":35265,"å›½":22269,"ä¸­":20013,"èµ·":36215,"ç¾":32654,
      "å†™":20889,"ç”¨":29992,"å¤š":22810,"è°¢":35874,"ç‚¹":28857,"ä¸œ":19996,"è¥¿":35199,"å°‘":23569,"è¾¹":36793,"å°±":23601,
      "å¦‚":22914,"è¿˜":36824,"æœ":26524,"æ‰€":25152,"é‚£":37027,"åœ°":22320,"æ–¹":26041,"å¤":22799,"çƒ­":28909,"é˜³":38451,
      "æ¯”":27604,"å‡":20551,"åš":20570,"è¿‡":36807,"å¾—":24471,"é€":36865,"ä½":20303,"é¥­":39277,"è‡ª":33258,"å·±":24049,
      "å¥¶":22902,"çˆ·":29239,"æˆ¿":25151,"åŠ ":21152,"å†·":20919,"ç§‹":31179,"ç­‰":31561,"äº":20110,"å–":21917,"çŸ¥":30693,
      "é“":36947,"æ—©":26089,"åˆ":21320,"æ™š":26202,"ç€":30528,"ç´¯":32047,"ç¡":30561,"è§‰":35273,"åºŠ":24202,"ç”»":30011,
      "çº¢":32418,"ç™½":30333,"äº‘":20113,"æŠŠ":25226,"æ‹¿":25343,"åˆ":21448,"è‰²":33394,"å¿ƒ":24515,"ä¹°":20080,"é’±":38065,
      "ç™¾":30334,"æ•°":25968,"å—":22359,"æ‰¾":25214,"çœŸ":30495,"ç°":29616,"è¯·":35831,"é—®":38382,"ä»":20174,"è¿œ":36828,
      "è¿‘":36817,"æ—":26049,"å…¬":20844,"å›­":22253,"åª":21482,"è¡Œ":34892,"è½¦":36710,"é£":39134,"æœº":26426,"è·‘":36305,
      "æ…¢":24930,"æ›´":26356,"æœ€":26368,"çƒ":29699,"æ‰“":25171,"æ¬¡":27425,"åˆ†":20998,"å½“":24403,"é":38750,"å¸¸":24120,
      "å†¬":20908,"ç¬¬":31532,"æ°‘":27665,"æ”¶":25910,"è¡£":34915,"æœ":26381,"æ²³":27827,"ç‹—":29399,"åŠ©":21161,"ç½‘":32593,
      "å®ƒ":23427,"æ˜¥":26149,"èŠ‚":33410,"åŒ…":21253,"å­©":23401,"æ–°":26032,"é—¨":38376,"å£":21475,"ç©¿":31359,"ä¸¾":20030,
      "å¬":21548,"è¯":35805,"å¿˜":24536,"è®°":35760,"ç­”":31572,"æ•™":25945,"çº§":32423,"æ‰‹":25163,"åº—":24215,"å¼€":24320,
      "å…³":20851,"é€‰":36873,"åˆ«":21035,"äº›":20123,"å…ˆ":20808,"ç„¶":28982,"ç¬‘":31505,"å“­":21741,"æ€•":24597,"é»‘":40657,
      "ä½†":20294,"å›¾":22270,"å˜":21464,"æˆ":25104,"åº”":24212,"è¯¥":35813,"æ´—":27927,"å¤´":22836,"æ‰":25165,"åŠ¨":21160,
      "è®©":35753,"å®Œ":23436,"åˆš":21018
    };

    /*************************************************************************
     * å·¥å…·ï¼šæ‹¼éŸ³åŠ éŸ³è°ƒï¼ˆå¸¦ iu/ui ç‰¹æ®Šè§„åˆ™ï¼‰
     *************************************************************************/
    function markTone(syllable, tone) {
      if (!tone || tone === 0) return syllable;
      let s = syllable.replace(/v/g, "Ã¼");
      // tone maps
      const toneMap = {
        'a': ['Ä','Ã¡','Ç','Ã '],
        'o': ['Å','Ã³','Ç’','Ã²'],
        'e': ['Ä“','Ã©','Ä›','Ã¨'],
        'i': ['Ä«','Ã­','Ç','Ã¬'],
        'u': ['Å«','Ãº','Ç”','Ã¹'],
        'Ã¼': ['Ç–','Ç˜','Çš','Çœ']
      };

      // If contains 'iu' or 'ui' handle specially:
      const lower = s.toLowerCase();
      let targetIndex = -1;

      if (lower.includes('iu')) {
        // tone mark should be on 'u'
        targetIndex = lower.indexOf('iu') + 1; // index of 'u'
      } else if (lower.includes('ui')) {
        // tone mark should be on 'i'
        targetIndex = lower.indexOf('ui') + 0; // index of 'i'
      } else {
        // regular order a,o,e,i,u,Ã¼
        const order = ['a','o','e','i','u','Ã¼'];
        for (let ch of order) {
          const idx = lower.indexOf(ch);
          if (idx !== -1) { targetIndex = idx; break; }
        }
      }

      if (targetIndex === -1) return s;
      const ch = s[targetIndex];
      const chLower = ch.toLowerCase();
      const marks = toneMap[chLower];
      if (!marks) return s;
      const mark = marks[tone-1];
      s = s.substring(0,targetIndex) + mark + s.substring(targetIndex+1);
      return s;
    }

    /*************************************************************************
     * é¡µé¢ DOM ä¸çŠ¶æ€
     *************************************************************************/
    const gradeBtns = document.querySelectorAll(".grade-btn");
    const numBtns = document.querySelectorAll(".num-btn");
    const customInput = document.getElementById("custom-num");
    const startBtn = document.getElementById("start-game");
    const homeSection = document.getElementById("home");
    const gameSection = document.getElementById("game");
    const endSection = document.getElementById("end");
    const gameGradeEl = document.getElementById("game-grade");
    const qCountEl = document.getElementById("q-count");
    const strokeGifEl = document.getElementById("stroke-gif");
    const metaLineEl = document.getElementById("meta-line");
    const playSoundBtn = document.getElementById("play-sound");
    const choicesEl = document.getElementById("choices");
    const nextBtn = document.getElementById("next-btn");
    const quitBtn = document.getElementById("quit-btn");
    const progressBar = document.getElementById("progress-bar");
    const scoreText = document.getElementById("score-text");
    const finalScoreEl = document.getElementById("final-score");
    const toneGrid = document.getElementById("tone-grid");
    const encourageEl = document.getElementById("encourage");
    const retryBtn = document.getElementById("retry-btn");
    const backHomeBtn = document.getElementById("back-home-btn");
    const audioEl = document.getElementById("audio");

    // å½•éŸ³ç›¸å…³
    const recBtn = document.getElementById("rec-btn");
    const stopRecBtn = document.getElementById("stop-rec-btn");
    const playRecBtn = document.getElementById("play-rec-btn");
    const recStatus = document.getElementById("rec-status");
    const userRecAudio = document.getElementById("user-rec-audio");

    let mediaStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    // å­˜å‚¨ per-question å½•éŸ³ blob ï¼ˆç”¨é¢˜åº index æ ‡è®°ï¼‰
    let userRecordings = {}; // key: questionIndex (cur), value: Blob URL

    // state
    let selectedGrade = 1;
    let selectedNum = "all";
    let customNum = null;
    let pool = []; // objects {char,pinyinBase,tone}
    let order = []; // indices into pool
    let cur = 0;
    let total = 0;
    let score = 0;
    let toneStats = {1:{total:0,correct:0},2:{total:0,correct:0},3:{total:0,correct:0},4:{total:0,correct:0}};
    let toneWeights = {1:1,2:1,3:1,4:1};

    // init selections
    gradeBtns.forEach(btn=>{
      btn.addEventListener("click", ()=> {
        gradeBtns.forEach(b=>b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedGrade = parseInt(btn.dataset.grade,10);
      });
    });
    numBtns.forEach(btn=>{
      btn.addEventListener("click", ()=> {
        numBtns.forEach(b=>b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedNum = btn.dataset.num;
        customInput.value = ""; customNum = null;
      });
    });
    customInput.addEventListener("input", ()=>{
      const v = parseInt(customInput.value,10);
      if (!isNaN(v) && v>0) {
        numBtns.forEach(b=>b.classList.remove("selected"));
        selectedNum = "custom";
        customNum = v;
      } else {
        customNum = null;
      }
    });

    // helper shuffle
    function shuffleArray(a) {
      const arr = a.slice();
      for (let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    // build pool
    function buildPool(grade) {
      const arr = gradeChars[grade] || [];
      return arr.map(ch=>{
        const info = pinyinMap[ch];
        if (info) return {char:ch,pinyinBase:info.pinyinBase,tone:info.tone||0};
        return {char:ch,pinyinBase:ch,tone:0};
      });
    }

    // weighted shuffle: pick order with weights based on toneWeights
    function generateOrderForPool(p) {
      const w = p.map((item, idx) => {
        const t = item.tone;
        if (!t || t===0) return 0.3;
        // if array, take avg weight
        if (Array.isArray(t)) {
          return t.reduce((s,tt)=>s + (toneWeights[tt]||1),0)/t.length;
        }
        return toneWeights[t] || 1;
      });
      const available = p.map((_,i)=>i);
      const result = [];
      while (available.length>0) {
        const totalW = available.reduce((s,i)=>s + w[i],0);
        if (totalW <= 0) {
          const idx = Math.floor(Math.random()*available.length);
          result.push(available.splice(idx,1)[0]);
          continue;
        }
        let r = Math.random()*totalW;
        let chosen = null;
        for (const i of available) {
          r -= w[i];
          if (r <= 0) { chosen = i; break; }
        }
        if (chosen === null) chosen = available[available.length-1];
        const pos = available.indexOf(chosen);
        available.splice(pos,1);
        result.push(chosen);
      }
      return result;
    }

    /*************************************************************************
     * å¼€å§‹æ¸¸æˆ
     *************************************************************************/
    startBtn.addEventListener("click", ()=>{
      pool = buildPool(selectedGrade);

      let n = pool.length;
      if (selectedNum === "10") n = Math.min(10, pool.length);
      else if (selectedNum === "20") n = Math.min(20, pool.length);
      else if (selectedNum === "all") n = pool.length;
      else if (selectedNum === "custom" && customNum && customNum>0) n = Math.min(customNum, pool.length);

      if (n < pool.length) {
        pool = shuffleArray(pool).slice(0, n);
      }

      total = pool.length;
      toneStats = {1:{total:0,correct:0},2:{total:0,correct:0},3:{total:0,correct:0},4:{total:0,correct:0}};
      score = 0; cur = 0;
      order = generateOrderForPool(pool);

      document.getElementById("home").style.display = "none";
      document.getElementById("game").style.display = "block";
      document.getElementById("end").style.display = "none";
      gameGradeEl.textContent = `å¹´çº§ ${["","ä¸€å¹´çº§","äºŒå¹´çº§","ä¸‰å¹´çº§","å››å¹´çº§"][selectedGrade] || selectedGrade}`;
      qCountEl.textContent = `${cur+1} / ${total}`;
      scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
      progressBar.style.width = `0%`;

      // clear recordings map for new round
      userRecordings = {};
      showQuestion(0);
    });

    function showQuestion(idxInOrder) {
      const idx = order[idxInOrder];
      const q = pool[idx];
      // æ˜¾ç¤ºç¬”é¡º gif
      const code = charCodeMap[q.char];
      if (code) {
        strokeGifEl.src = `https://www.strokeorder.com/assets/bishun/animation/${code}.gif`;
        strokeGifEl.alt = `${q.char} Stroke Order Animation`;
        strokeGifEl.title = `${q.char} ç¬”é¡ºåŠ¨ç”»`;
      } else {
        strokeGifEl.src = "";
        strokeGifEl.alt = q.char;
        strokeGifEl.title = q.char;
      }

      // æ˜¾ç¤ºé‡Šä¹‰ï¼ˆä¿ç•™è¯æ€§ï¼‰
      let lx = lexicon[q.char] || "ï¼ˆé‡Šä¹‰æš‚ç¼ºï¼‰";
      metaLineEl.textContent = lx;

      // build options 1-4
      choicesEl.innerHTML = "";
      for (let t=1; t<=4; t++){
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = markTone(q.pinyinBase, t);
        btn.dataset.tone = t;
        btn.addEventListener("click", ()=> handleChoice(btn, q));
        choicesEl.appendChild(btn);
      }

      // update toneStats total opportunities:
      // if q.tone is array, increment total for each tone possibility
      if (Array.isArray(q.tone)) {
        q.tone.forEach(tt => { if (toneStats[tt]) toneStats[tt].total++; });
      } else {
        if (q.tone && toneStats[q.tone]) toneStats[q.tone].total++;
      }

      // autoplay audio (archchinese)
      playAudio(q.pinyinBase, Array.isArray(q.tone) ? (q.tone[0]||"") : q.tone);

      // controls
      nextBtn.style.display = "none";
      qCountEl.textContent = `${cur+1} / ${total}`;
      const p = Math.round((cur/Math.max(1,total))*100);
      progressBar.style.width = p + "%";

      // restore per-question recording UI if already recorded
      const recKey = `${cur}`;
      if (userRecordings[recKey]) {
        playRecBtn.style.display = "inline-block";
        userRecAudio.src = userRecordings[recKey];
        userRecAudio.style.display = "inline-block";
        recStatus.textContent = "ï¼ˆå·²å½•éŸ³ï¼‰";
      } else {
        playRecBtn.style.display = "none";
        userRecAudio.style.display = "none";
        if (mediaRecorder && mediaRecorder.state === "recording") {
          // nothing
        } else {
          recStatus.textContent = "ï¼ˆæœªå½•éŸ³ï¼‰";
        }
        userRecAudio.src = "";
      }
    }

    // æ’­æ”¾é¢˜å¹²éŸ³ï¼šä¼˜å…ˆ ArchChinese: https://www.archchinese.com/swf/<pinyin><tone>.mp3
    function playAudio(pinyinBase, tone) {
      let url = "";
      if (tone && tone > 0) {
        url = `https://www.archchinese.com/swf/${pinyinBase}${tone}.mp3`;
      } else {
        url = `https://www.archchinese.com/swf/${pinyinBase}.mp3`;
      }
      audioEl.src = url;
      audioEl.play().catch(()=>{/* silent */});
    }

    playSoundBtn.addEventListener("click", ()=>{
      const idx = order[cur];
      const q = pool[idx];
      if (q) playAudio(q.pinyinBase, Array.isArray(q.tone) ? (q.tone[0]||"") : q.tone);
    });

    function handleChoice(btn, q) {
      // disable all
      document.querySelectorAll(".choice").forEach(b=>b.disabled=true);
      const chosen = parseInt(btn.dataset.tone,10);

      // check correctness (support multi-tone)
      let correct = false;
      if (Array.isArray(q.tone)) {
        correct = q.tone.includes(chosen);
      } else {
        correct = (chosen === q.tone);
      }

      if (correct) {
        btn.classList.add("correct");
        score++;
        // increase correct count for the chosen tone
        if (toneStats[chosen]) toneStats[chosen].correct++;
      } else {
        btn.classList.add("wrong");
        // highlight correct(s)
        const correctTones = Array.isArray(q.tone) ? q.tone : [q.tone];
        Array.from(document.querySelectorAll(".choice")).forEach(b=>{
          const t = parseInt(b.dataset.tone,10);
          if (correctTones.includes(t)) b.classList.add("correct");
        });
      }
      scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
      nextBtn.style.display = "inline-block";
    }

    nextBtn.addEventListener("click", ()=>{
      cur++;
      if (cur < total) {
        showQuestion(cur);
      } else {
        finishRound();
      }
    });

    quitBtn.addEventListener("click", finishRound);

    function finishRound() {
      document.getElementById("game").style.display = "none";
      document.getElementById("end").style.display = "block";
      finalScoreEl.textContent = `${score} / ${total}`;
      toneGrid.innerHTML = "";
      for (let t=1; t<=4; t++){
        const st = toneStats[t];
        const div = document.createElement("div");
        div.className = "tone-item";
        if (!st.total) {
          div.textContent = `${t}å£°ï¼š0/0 (N/A)`;
        } else {
          const rate = Math.round((st.correct / st.total)*100);
          div.textContent = `${t}å£°ï¼š${st.correct}/${st.total} (${rate}%)`;
        }
        toneGrid.appendChild(div);
      }
      const phrases = [
        "ä½ çœŸæ£’ï¼ç»§ç»­åŠ æ²¹ ğŸ’ª",
        "å¤ªæ£’äº†ï¼å†æŒ‘æˆ˜ä¸€æ¬¡å§ ğŸŒŸ",
        "åšå¥½å•¦ï¼ç»§ç»­ä¿æŒå¥½ä¹ æƒ¯ ğŸ˜Š",
        "å¾ˆæ£’çš„è¿›æ­¥ï¼Œç»§ç»­ç»ƒå°±æ›´æ£’ï¼ğŸ‰",
        "ä¼˜ç§€ï¼ä½ çš„å‘éŸ³æ›´è¿›ä¸€æ­¥äº†ï¼ğŸ‘"
      ];
      encourageEl.textContent = phrases[Math.floor(Math.random()*phrases.length)];
      adjustToneWeights();
    }

    function adjustToneWeights() {
      for (let t=1; t<=4; t++){
        const st = toneStats[t];
        let acc = 1.0;
        if (st.total > 0) acc = st.correct / st.total;
        let newW = 0.5 + (1 - acc) * 2.5;
        newW = Math.max(0.3, Math.min(newW, 4));
        toneWeights[t] = newW;
      }
      const s = Object.values(toneWeights).reduce((a,b)=>a+b,0);
      for (let t=1;t<=4;t++) toneWeights[t] = toneWeights[t]/s*4;
    }

    retryBtn.addEventListener("click", ()=>{
      toneStats = {1:{total:0,correct:0},2:{total:0,correct:0},3:{total:0,correct:0},4:{total:0,correct:0}};
      score = 0; cur = 0;
      order = generateOrderForPool(pool);
      document.getElementById("end").style.display = "none";
      document.getElementById("game").style.display = "block";
      gameGradeEl.textContent = `å¹´çº§ ${["","ä¸€å¹´çº§","äºŒå¹´çº§","ä¸‰å¹´çº§","å››å¹´çº§"][selectedGrade] || selectedGrade}`;
      qCountEl.textContent = `${cur+1} / ${total}`;
      scoreText.textContent = `å¾—åˆ†ï¼š${score}`;
      progressBar.style.width = `0%`;
      showQuestion(0);
    });

    backHomeBtn.addEventListener("click", ()=>{
      document.getElementById("end").style.display = "none";
      document.getElementById("game").style.display = "none";
      document.getElementById("home").style.display = "block";
    });

    // init defaults
    document.querySelector('.grade-btn[data-grade="1"]').classList.add('selected');
    document.querySelector('.num-btn[data-num="all"]').classList.add('selected');
    selectedGrade = 1; selectedNum = "all";

    // Keyboard: Enter to start
    document.addEventListener("keydown",(e)=>{
      if (e.key === "Enter" && document.getElementById("home").style.display !== "none") {
        startBtn.click();
      }
    });

    /*************************************************************************
     * å½•éŸ³åŠŸèƒ½ï¼ˆMediaRecorderï¼‰â€”â€”å°½é‡åªè¯·æ±‚ä¸€æ¬¡æƒé™ï¼Œåç»­å¤ç”¨ stream
     *************************************************************************/
    async function ensureMediaStream() {
      if (mediaStream) return mediaStream;
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        return mediaStream;
      } catch (err) {
        console.error("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼š", err);
        alert("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®å¹¶å…è®¸éº¦å…‹é£è®¿é—®ã€‚");
        throw err;
      }
    }

    recBtn.addEventListener("click", async ()=>{
      try {
        const stream = await ensureMediaStream();
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = function(e) {
          if (e.data && e.data.size > 0) recordedChunks.push(e.data);
        };
        mediaRecorder.onstart = function() {
          recStatus.textContent = "ï¼ˆæ­£åœ¨å½•éŸ³...ï¼‰";
          recBtn.style.display = "none";
          stopRecBtn.style.display = "inline-block";
        };
        mediaRecorder.onstop = function() {
          const blob = new Blob(recordedChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          // å­˜å‚¨åˆ°å½“å‰é¢˜ç›®çš„å½•éŸ³ï¼ˆç”¨ cur ä½œä¸º keyï¼‰
          const recKey = `${cur}`;
          // å¦‚æœä¹‹å‰æœ‰ï¼Œå…ˆ revoke
          if (userRecordings[recKey]) {
            try { URL.revokeObjectURL(userRecordings[recKey]); } catch(e){}
          }
          userRecordings[recKey] = url;
          userRecAudio.src = url;
          userRecAudio.style.display = "inline-block";
          playRecBtn.style.display = "inline-block";
          recStatus.textContent = "ï¼ˆå·²å½•éŸ³ï¼‰";
          recBtn.style.display = "inline-block";
          stopRecBtn.style.display = "none";
        };
        mediaRecorder.start();
      } catch (err) {
        console.error("å½•éŸ³å¯åŠ¨å¤±è´¥ï¼š", err);
      }
    });

    stopRecBtn.addEventListener("click", ()=>{
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    });

    playRecBtn.addEventListener("click", ()=>{
      const recKey = `${cur}`;
      if (userRecordings[recKey]) {
        userRecAudio.play().catch(()=>{});
      } else {
        alert("å½“å‰é¢˜ç›®å°šæœªå½•éŸ³ã€‚");
      }
    });

    // é¡µé¢å¸è½½æ—¶ revoke blob urls
    window.addEventListener("beforeunload", ()=>{
      Object.values(userRecordings).forEach(url=>{
        try { URL.revokeObjectURL(url); } catch(e){}
      });
    });

  </script>
</body>
</html>
